<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <title>Document</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
</head>
<body>
    <div class="background"></div>

    <div class="page" id="page0">
        <div class='contents' style='position: absolute; width: 60%; left: 20%; text-align: center'>
            <h1>
                Press the button below to begin the next trial!
            </h1> 
            <button class='button' id="fullscreen-page-0">Begin Trial</button>
        </div>
    </div>

    <div class="page hidden" id="page1">
        <div class="contents" style="position: absolute; width: 60%; left: 20%;">
            <h1 id="case-counter">Case:</h1>
            <p id="vignette-text-p1">
                PLACEHOLDER VIGNETTE TEXT
            </p>
            <p style="font-weight: bold;">
                Please review the case and provide your decision
                about diagnosis and management.
            </p>
            <div style="height: 1px; width: 100%; background-color:#20a5d6;"></div>
            <br/>
            <label for="ta-p1-A">What is your provisional diagnosis?</label>
            <br/>
            <textarea id="ta-p1-A" name="ta-p1-A" rows="4" cols="50"></textarea>
            <h2>Please rate your confidence in the provisional diagnosis?</h2>
            <div>
                <ul class="radio-button">
                    <li>
                        <input type="radio" id="rb-p1-A1" name="rb-p1-A" data-name="1"/>
                        <label for="rb-p1-A1">Very Unconfident</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p1-A2" name="rb-p1-A" data-name="2"/>
                        <label for="rb-p1-A2">Unconfident</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p1-A3" name="rb-p1-A" data-name="3"/>
                        <label for="rb-p1-A3">Slightly Unconfident</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p1-A4" name="rb-p1-A" data-name="4"/>
                        <label for="rb-p1-A4">Neither</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p1-A5" name="rb-p1-A" data-name="5"/>
                        <label for="rb-p1-A5">Slightly Confident</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p1-A6" name="rb-p1-A" data-name="6"/>
                        <label for="rb-p1-A6">Confident</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p1-A7" name="rb-p1-A" data-name="7"/>
                        <label for="rb-p1-A7">Very Confident</label>
                    </li>
                </ul>
            </div>
            <br style="clear:both"/>
            <br/>
            <div style="width: 100%;">
                <p class="errors" id="errors-p1" style="float: left;"></p>
                <button class="button" id="continue-button-p1" style="float: right; margin-top: 20px;">
                    View CXR/Continue ðŸ¡†
                </button>
            </div>
        </div>
    </div>

    <div id="page2" class="hidden page">
        <div id="xray-viewer">
            <iframe id="xray-viewer-iframe" class="max-width-height" src="" frameborder="0"></iframe>
        </div>
        <div id="decision-support">
            <h1 id="decision-placeholder">Decision support is not available for this patient</h1>
            <div id="decision-support-container" class="max-width-height">
                <iframe id="decision-support-iframe" class="max-width-height" src="" frameborder="0"></iframe>
            </div>
        </div>
        <div class="container" id="vignette-p2">
            <p class="contents" id="vignette-text-p2">
                PLACEHOLDER VIGNETTE TEXT
            </p>
        </div>
        <div class="container" id="response-container">
            <div class="contents reduce-v-padding" id="response">

                <p style="display: inline-block; margin-top: -10px;">Does the CXR demonstrate pathology?</p>
                <div style="display: inline-block;">
                    <ul class="radio-button short">
                        <li>
                            <input type="radio" id="rb-p2-A-Yes" name="rb-p2-A" value="Yes"/>
                            <label for="rb-p2-A-Yes">Yes</label>
                        </li>
                        <li>
                            <input type="radio" id="rb-p2-A-No" name="rb-p2-A" value="No"/>
                            <label for="rb-p2-A-No">No</label>
                        </li>
                    </ul>
                </div>
                <textarea placeholder="How does it demonstrate pathology?" id="ta-p2-A" name="ta-p2-A" class="hide" rows="4" cols="50"></textarea>
                <br/>

                <p style="display: inline-block; margin-top: -10px;">Does patient urgently (&#60;6hrs) require further imaging?</p>
                <div style="display: inline-block;">
                    <ul class="radio-button short">
                        <li>
                            <input type="radio" id="rb-p2-B-Yes" name="rb-p2-B" value="Yes"/>
                            <label for="rb-p2-B-Yes">Yes</label>
                        </li>
                        <li>
                            <input type="radio" id="rb-p2-B-No" name="rb-p2-B" value="No"/>
                            <label for="rb-p2-B-No">No</label>
                        </li>
                    </ul>
                </div>
                <textarea placeholder="Please elaborate" id="ta-p2-B" name="ta-p2-B" class="hide" rows="4" cols="50"></textarea>
                <br/>

                <p style="display: inline-block; margin-top: -10px;">Does patient require urgent (&#60;6hrs) management?</p>
                <div style="display: inline-block;">
                    <ul class="radio-button short">
                        <li>
                            <input type="radio" id="rb-p2-C-Yes" name="rb-p2-C" value="Yes"/>
                            <label for="rb-p2-C-Yes">Yes</label>
                        </li>
                        <li>
                            <input type="radio" id="rb-p2-C-No" name="rb-p2-C" value="No"/>
                            <label for="rb-p2-C-No">No</label>
                        </li>
                    </ul>
                </div>
                <textarea placeholder="Please elaborate" id="ta-p2-C" name="ta-p2-C" class="hide" rows="4" cols="50"></textarea>
                <br/>
                
                <p style="display: inline-block; margin-top: -10px;">Will you admit this patient?</p>
                <div style="display: inline-block;">
                    <ul class="radio-button short">
                        <li>
                            <input type="radio" id="rb-p2-D-Yes" name="rb-p2-D" value="Yes"/>
                            <label for="rb-p2-D-Yes">Yes</label>
                        </li>
                        <li>
                            <input type="radio" id="rb-p2-D-No" name="rb-p2-D" value="No"/>
                            <label for="rb-p2-D-No">No</label>
                        </li>
                    </ul>
                </div>
                <textarea placeholder="How does it demonstrate pathology?" id="ta-p2-D" name="ta-p2-D" class="hide" rows="4" cols="50"></textarea>
                <br/>

                If you discharge this patient, what follow up does the patient require?
                <div style="margin: -20px -10px 50px 0px;">
                    <ul class="radio-button short" style="margin-top: -5px;">
                        <li>
                            <input type="radio" id="rb-p2-E-GP" name="rb-p2-E" value="GP review"/>
                            <label for="rb-p2-E-GP">GP review</label>
                        </li>
                        <li>
                            <input type="radio" id="rb-p2-E-Spec" name="rb-p2-E" value="Specialist review"/>
                            <label for="rb-p2-E-Spec">Specialist review</label>
                        </li>
                        <li>
                            <input type="radio" id="rb-p2-E-Prog" name="rb-p2-E" value="Progress imaging"/>
                            <label for="rb-p2-E-Prog">Progress imaging</label>
                        </li>
                        <li>
                            <input type="radio" id="rb-p2-E-Nil" name="rb-p2-E" value="Nil specific"/>
                            <label for="rb-p2-E-Nil">Nil specific</label>
                        </li>
                    </ul>
                </div>
                <br/>
                <textarea placeholder="Briefly outline follow up required" id="ta-p2-E" name="ta-p2-E" class="hide" rows="4" cols="50"></textarea>
                
                
                <p class="errors" id="errors-p2"></p>
                <div style="width: 100%; display: table;">
                    <button class="button" id="continue-button-p2">
                        Submit and continue ðŸ¡†
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="page3" class="hidden page">
        <div class="contents" style="position: absolute; width: 80%; left: 10%; top: 15%; height: 70%">
            
            <h2>Please rate your confidence in this diagnosis.</h2>
            <div>
                <ul class="radio-button large">
                    <li>
                        <input type="radio" id="rb-p3-A1" name="rb-p3-A" data-name="1"/>
                        <label for="rb-p3-A1">Very Unconfident</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p3-A2" name="rb-p3-A" data-name="2"/>
                        <label for="rb-p3-A2">Unconfident</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p3-A3" name="rb-p3-A" data-name="3"/>
                        <label for="rb-p3-A3">Slightly Unconfident</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p3-A4" name="rb-p3-A" data-name="4"/>
                        <label for="rb-p3-A4">Neither</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p3-A5" name="rb-p3-A" data-name="5"/>
                        <label for="rb-p3-A5">Slightly Confident</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p3-A6" name="rb-p3-A" data-name="6"/>
                        <label for="rb-p3-A6">Confident</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p3-A7" name="rb-p3-A" data-name="7"/>
                        <label for="rb-p3-A7">Very Confident</label>
                    </li>
                </ul>
            </div>
            <br style="clear:both"/>
            <br style="clear:both"/>

            <h2>I considered the output of the Chest X-ray AI in my clinical decisions for this patient scenario.</h2>
            <div>
                <ul class="radio-button large">
                    <li>
                        <input type="radio" id="rb-p3-B1" name="rb-p3-B" data-name="1"/>
                        <label for="rb-p3-B1">Strongly Disagree</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p3-B2" name="rb-p3-B" data-name="2"/>
                        <label for="rb-p3-B2">Disagree</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p3-B3" name="rb-p3-B" data-name="3"/>
                        <label for="rb-p3-B3">Slightly Disagree</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p3-B4" name="rb-p3-B" data-name="4"/>
                        <label for="rb-p3-B4">Neither</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p3-B5" name="rb-p3-B" data-name="5"/>
                        <label for="rb-p3-B5">Slightly Agree</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p3-B6" name="rb-p3-B" data-name="6"/>
                        <label for="rb-p3-B6">Agree</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p3-B7" name="rb-p3-B" data-name="7"/>
                        <label for="rb-p3-B7">Strongly Agree</label>
                    </li>
                </ul>
            </div>
            <br style="clear:both"/>
            <br style="clear:both"/>

            <h2>The content of this patient scenario was very complex.</h2>
            <div>
                <ul class="radio-button large">
                    <li>
                        <input type="radio" id="rb-p3-C0" name="rb-p3-C" data-name="0"/>
                        <label for="rb-p3-C0">0 (Not at all the case)</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p3-C1" name="rb-p3-C" data-name="1"/>
                        <label for="rb-p3-C1">1</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p3-C2" name="rb-p3-C" data-name="2"/>
                        <label for="rb-p3-C2">2</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p3-C3" name="rb-p3-C" data-name="3"/>
                        <label for="rb-p3-C3">3</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p3-C4" name="rb-p3-C" data-name="4"/>
                        <label for="rb-p3-C4">4</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p3-C5" name="rb-p3-C" data-name="5"/>
                        <label for="rb-p3-C5">5</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p3-C6" name="rb-p3-C" data-name="6"/>
                        <label for="rb-p3-C6">6</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p3-C7" name="rb-p3-C" data-name="7"/>
                        <label for="rb-p3-C7">7</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p3-C8" name="rb-p3-C" data-name="8"/>
                        <label for="rb-p3-C8">8</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p3-C9" name="rb-p3-C" data-name="9"/>
                        <label for="rb-p3-C9">9</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p3-C10" name="rb-p3-C" data-name="10"/>
                        <label for="rb-p3-C10">10 (Completely the case)</label>
                    </li>
                </ul>
            </div>
            <br style="clear:both"/>
            <br style="clear:both"/>

            <h2>I invested a very high mental effort in the complexity of this patient scenario.</h2>
            <div>
                <ul class="radio-button large">
                    <li>
                        <input type="radio" id="rb-p3-D0" name="rb-p3-D" data-name="0"/>
                        <label for="rb-p3-D0">0 (Not at all the case)</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p3-D1" name="rb-p3-D" data-name="1"/>
                        <label for="rb-p3-D1">1</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p3-D2" name="rb-p3-D" data-name="2"/>
                        <label for="rb-p3-D2">2</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p3-D3" name="rb-p3-D" data-name="3"/>
                        <label for="rb-p3-D3">3</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p3-D4" name="rb-p3-D" data-name="4"/>
                        <label for="rb-p3-D4">4</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p3-D5" name="rb-p3-D" data-name="5"/>
                        <label for="rb-p3-D5">5</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p3-D6" name="rb-p3-D" data-name="6"/>
                        <label for="rb-p3-D6">6</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p3-D7" name="rb-p3-D" data-name="7"/>
                        <label for="rb-p3-D7">7</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p3-D8" name="rb-p3-D" data-name="8"/>
                        <label for="rb-p3-D8">8</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p3-D9" name="rb-p3-D" data-name="9"/>
                        <label for="rb-p3-D9">9</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p3-D10" name="rb-p3-D" data-name="10"/>
                        <label for="rb-p3-D10">10 (Completely the case)</label>
                    </li>
                </ul>
            </div>
            <br style="clear:both"/>
            <br style="clear:both"/>

            <h2>The patient scenario I just finished was...</h2>
            <div>
                <ul class="radio-button large">
                    <li>
                        <input type="radio" id="rb-p3-E1" name="rb-p3-E" data-name="1"/>
                        <label for="rb-p3-E1">Very Easy</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p3-E2" name="rb-p3-E" data-name="2"/>
                        <label for="rb-p3-E2">Easy</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p3-E3" name="rb-p3-E" data-name="3"/>
                        <label for="rb-p3-E3">Slightly Easy</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p3-E4" name="rb-p3-E" data-name="4"/>
                        <label for="rb-p3-E4">Neither</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p3-E5" name="rb-p3-E" data-name="5"/>
                        <label for="rb-p3-E5">Slightly Hard</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p3-E6" name="rb-p3-E" data-name="6"/>
                        <label for="rb-p3-E6">Hard</label>
                    </li>
                    <li>
                        <input type="radio" id="rb-p3-E7" name="rb-p3-E" data-name="7"/>
                        <label for="rb-p3-E7">Very Hard</label>
                    </li>
                </ul>
            </div>
            <br style="clear:both"/>
            <br/>

            <div style="width: 100%; display: table;">
                <p class="errors" id="errors-p3" style="float: left;"></p>
                <button class="button" id="continue-button-p3" style="float: right;">
                    Submit/Continue ðŸ¡†
                </button>
            </div>
        </div>
    </div>

    <div id="lowerButtons">
        <button onclick="toggleFullscreen()" id="fullscreen-button" class="lilBtn">
            â›¶ Fullscreen 
        </button>
    </div>
    
    <script>
        // This event is triggered when the user presses the submit button on the third screen
        
        //const submitEvent = new CustomEvent('submitResponse', {response: {}});

        // Variables to store time spent on each page

        let startPage1, startPage2, startPage3, endPage3;

        // Initialize onClick functions

        $("#fullscreen-page-0").click(() => {
            openFullscreen();
            showPage(1);
            startPage1 = Date.now();
        })

        $("#continue-button-p1").click(() => {
            const errors = validatePage1Inputs();
            if (errors) {
                $('#errors-p1').html(errors.toString().replaceAll(',','<br>'));
                console.log(errors);
            } else {
                showPage(2);
                startPage2 = Date.now();
            }
        })

        $("#continue-button-p2").click(() => {
            const errors = validatePage2Inputs();
            if (errors) {
                $('#errors-p2').html(errors.toString().replaceAll(',','<br>'));
                console.log(errors);
            } else {
                showPage(3);
                startPage3 = Date.now();
            }
        })

        // Boolean used to ensure that the final button isn't somehow activated twice
        let taskComplete = false;

        $("#continue-button-p3").click(() => {
            const errors = validatePage3Inputs();
            if (errors) {
                $('#errors-p3').html(errors.toString().replaceAll(',','<br>'));
                console.log(errors);
            } else if (!taskComplete) {
                endPage3 = Date.now();
                window.parent.postMessage(retrieveAnswers(), '*');
                closeFullscreen();
                taskComplete = true;
            }
        })

        // Setup textarea hiding

        function setupCollapsableTextArea(subID) {
            $(`input[type=radio][name=rb-${subID}]`).change(function() {
                // If "yes" is selected in the radio button group, show the textarea and focus it
                if (this.value == 'Yes') {
                    $(`#ta-${subID}`).removeClass("hide");
                    $(`#ta-${subID}`).focus();
                } else {
                    $(`#ta-${subID}`).addClass("hide");
                }
            })
        }

        setupCollapsableTextArea("p2-A");
        setupCollapsableTextArea("p2-B");
        setupCollapsableTextArea("p2-C");
        setupCollapsableTextArea("p2-D");

        $(`input[type=radio][name=rb-p2-E]`).change(function() {
            if (this.value != 'Nil specific') {
                $(`#ta-p2-E`).removeClass("hide");
                $(`#ta-p2-E`).focus();
            } else {
                $(`#ta-p2-E`).addClass("hide");
            }
        })

        // Since Gorilla loads all screens of a task and hides them until they are used
        // I believe it gives us more control to have all of our own screens in a single
        // page, so we can choose how they interact with each other and how data is loaded
        // into them.

        let currentPage = 0;

        function showPage(page) {
            $(`#page${currentPage}`).addClass("hidden");
            currentPage = page;
            $(`#page${currentPage}`).removeClass("hidden");
        }

        // Setup turning radio buttons and text areas back to normal colours after error

        document.querySelectorAll("ul.radio-button").forEach(buttonGroup => {
            buttonGroup.querySelectorAll('input[type="radio"]').forEach(button => {
                button.addEventListener('change', () => {
                    buttonGroup.classList.remove("error");
                })
            })
        });

        document.querySelectorAll("textarea").forEach(textarea => {
            textarea.addEventListener('input', () => {
                textarea.classList.remove("error");
            })
        })

        // Checks that required radio buttons and associated text areas are complete

        function setupCheckedRadioButton(subID, errorString, errorList) {
            if ($(`input[name="rb-${subID}"]:checked`).length === 0) {
                document.querySelector(`input[name="rb-${subID}"]`).parentElement.parentElement.classList.add("error");
                errorList.push(errorString);
            }
        }


        function validatePage1Inputs() {
            const errors = [];

            if ($('#ta-p1-A').val().length === 0) {
                $('#ta-p1-A').addClass("error");
                errors.push("Missing provisional diagnosis");
            }
            setupCheckedRadioButton("p1-A", "Missing confidence in diagnosis", errors);

            if (errors.length > 0) return errors;
        }

        function validatePage2Inputs() {
            const errors = [];

            setupCheckedRadioButton("p2-A", "Missing yes/no for 'Does the CXR demonstrate pathology?'", errors);
            setupCheckedRadioButton("p2-B", "Missing yes/no for 'Does patient urgently (<6hrs) require further imaging?'", errors);
            setupCheckedRadioButton("p2-C", "Missing yes/no for 'Does patient require urgent (<6hrs) management?'", errors);
            setupCheckedRadioButton("p2-D", "Missing yes/no for 'Will you admit this patient?'", errors);
            setupCheckedRadioButton("p2-E", "Missing selection for 'If you discharge this patient what follow up does the patient require?'", errors);

            if ($('#ta-p2-A').val().length === 0 && $('#rb-p2-A-Yes:checked').length > 0) {
                $('#ta-p2-A').addClass("error");
                errors.push("Missing explanation for 'Does the CXR demonstrate pathology?'");
            }
            if ($('#ta-p2-B').val().length === 0 && $('#rb-p2-B-Yes:checked').length > 0) {
                $('#ta-p2-B').addClass("error");
                errors.push("Missing explanation for 'Does patient urgently (<6hrs) require further imaging?'");
            }
            if ($('#ta-p2-C').val().length === 0 && $('#rb-p2-C-Yes:checked').length > 0) {
                $('#ta-p2-C').addClass("error");
                errors.push("Missing explanation for 'Does patient require urgent (<6hrs) management?'");
            }
            if ($('#ta-p2-D').val().length === 0 && $('#rb-p2-D-Yes:checked').length > 0) {
                $('#ta-p2-D').addClass("error");
                errors.push("Missing explanation for 'Will you admit this patient?'");
            }
            if ($('#ta-p2-E').val().length === 0 && $('#rb-p2-E-Nil:checked').length === 0 && $('input[name="rb-p2-E"]:checked').length > 0) {
                $('#ta-p2-E').addClass("error");
                errors.push("Missing explanation for 'If you discharge this patient what follow up does the patient require?'");
            }

            if (errors.length > 0) return errors;
        }

        function validatePage3Inputs() {
            const errors = [];

            setupCheckedRadioButton("p3-A", "Missing answer for 'Please rate your confidence in this diagnosis.'", errors);
            setupCheckedRadioButton("p3-B", "Missing answer for 'I considered the output of the Chest X-ray AI in my clinical decisions for this patient scenario.'", errors);
            setupCheckedRadioButton("p3-C", "Missing answer for 'The content of this patient scenario was very complex.'", errors);
            setupCheckedRadioButton("p3-D", "Missing answer for 'I invested a very high mental effort in the complexity of this patient scenario.'", errors);
            setupCheckedRadioButton("p3-E", "Missing answer for 'The patient scenario I just finished was...'", errors);

            if (errors.length > 0) return errors;
        }

        // This function returns a JS object containing all of the user's answers

        function retrieveAnswers() {
            const answers = {};
            // Page 1
            answers.provisionalDiagnosis = $('#ta-p1-A').val();
            answers.initialConfidence = $('input[name="rb-p1-A"]:checked').data("name");

            // Page 2
            answers.pathologyYN = $('input[name="rb-p2-A"]:checked').attr("value");
            answers.pathologyAns = $('#ta-p2-A').val();
            answers.imagingYN = $('input[name="rb-p2-B"]:checked').attr("value");
            answers.imagingAns = $('#ta-p2-B').val();
            answers.managementYN = $('input[name="rb-p2-C"]:checked').attr("value");
            answers.managementAns = $('#ta-p2-C').val();
            answers.admitYN = $('input[name="rb-p2-D"]:checked').attr("value");
            answers.admitAns = $('#ta-p2-D').val();
            answers.followUp = $('input[name="rb-p2-E"]:checked').attr("value");
            answers.followUpOutline = $('#ta-p2-E').val();

            // Page 3
            answers.finalConfidence = $('input[name="rb-p3-A"]:checked').data("name");
            answers.consideredXRay = $('input[name="rb-p3-B"]:checked').data("name");
            answers.complexity = $('input[name="rb-p3-C"]:checked').data("name");
            answers.highMentalEffort = $('input[name="rb-p3-D"]:checked').data("name");
            answers.scenarioDifficulty = $('input[name="rb-p3-E"]:checked').data("name");

            // Timing
            answers.timeStartPage1 = startPage1;
            answers.timeStartPage2 = startPage2;
            answers.timeStartPage3 = startPage3;
            answers.timeEndPage3 = endPage3;

            console.log(answers);
            return answers;
        }

        // This function should be called to set the vignette, xray viewer and decision support on the page

        function loadVariables(vignette, viewer, support, trialNumber, totalTrials) {
            $('#vignette-text-p1').html(vignette);
            $('#vignette-text-p2').html(vignette);
            $('#xray-viewer-iframe').attr("src", viewer);
            if (support !== "") {
                $('#decision-support-iframe').attr("src", support);
            } else {
                $('#decision-placeholder').show();
            }
            $('#case-counter').text(`Patient ${trialNumber}/${totalTrials}`);
        }

        // Captures the message from Gorilla to load the variables
        window.addEventListener('message', event => {
            // IMPORTANT: check the origin of the data!
            if (event.origin.startsWith('https://app.gorilla.sc') || event.origin.startsWith('https://research.sc')) {
                // The data was sent from your site.
                // Data sent with postMessage is stored in event.data:
                console.log(event.data);
                loadVariables(event.data.vignette, event.data.xray, event.data.ai, event.data.trialNumber, event.data.totalTrials);
            } else {
                // The data was NOT sent from your site!
                // Be careful! Do not use it. This else branch is
                // here just for clarity, you usually shouldn't need it.
                return;
            }
        });

        // Fullscreen management

        var elem = document.documentElement;

        function toggleFullscreen() {
            if (document.fullscreenElement) {
                closeFullscreen();
            } else {
                openFullscreen();
            }
        }

        /* View in fullscreen */
        function openFullscreen() {
            $('#fullscreen-button').hide();
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.webkitRequestFullscreen) { /* Safari */
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) { /* IE11 */
                elem.msRequestFullscreen();
            }
        }

        /* Close fullscreen */
        function closeFullscreen() {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) { /* Safari */
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) { /* IE11 */
                document.msExitFullscreen();
            }
        }

        if (document.addEventListener) {
            document.addEventListener('fullscreenchange', exitHandler, false);
            document.addEventListener('mozfullscreenchange', exitHandler, false);
            document.addEventListener('MSFullscreenChange', exitHandler, false);
            document.addEventListener('webkitfullscreenchange', exitHandler, false);
        }

        function exitHandler()
        {
            if (!document.webkitIsFullScreen && !document.mozFullScreen && !document.msFullscreenElement)
            {
                $('#fullscreen-button').show();
            }
        }

        // Fullscreen check for page0, auto skips page if already fullscreen

        if (document.webkitIsFullScreen || document.mozFullScreen || document.msFullscreenElement) {
            showPage(1);
        }

    </script>
</body>
</html>